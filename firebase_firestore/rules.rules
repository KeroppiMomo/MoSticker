service cloud.firestore {
    function isBase64(str) {
        return str.matches('[a-zA-Z0-9+/]+={0,2}')
    }
    match /databases/{database}/documents {
        match /users/{uid} {
            allow read;
            allow update: if 
                request.auth.uid == uid &&
                request.resource.data.name is string;
        }
        match /packs/{packID} {
            function formatMatch() {
                return
                    request.resource.data.name is string && request.resource.data.name.size() < 128 &&
                    request.resource.data.last_edit is timestamp && request.resource.data.last_edit < request.time &&
                    request.resource.data.tray is string && isBase64(request.resource.data.tray) &&
                    request.resource.data.pngs is map &&
                    request.resource.data.webps is map &&
                    request.resource.data.downloads is number
            }
            allow read;
            allow create: if 
                request.auth != null &&
                request.auth.uid == request.resource.data.owner &&
                formatMatch() &&
                request.resource.data.downloads == 0;
            allow update: if
                request.auth != null &&
                request.auth.uid == request.resource.data.owner &&
                resource.data.owner == request.resource.data.owner &&
                formatMatch() &&
                ((request.resource.data.downloads == null && resource.data.downloads == null) ||
                 (request.resource.data.downloads == resource.data.downloads));
            allow delete: if 
                request.auth != null &&
                request.auth.uid == resource.data.owner;
        }
    }
}